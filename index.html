<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Speaking App 2.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f5f6fa; color:#222; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 18px; }
    header { text-align:center; padding: 10px 0 6px; }
    h1 { margin: 0; font-size: 1.7rem; }
    .sub { margin: 6px 0 0; color:#555; font-size: .95rem; }

    .card {
      background:#fff; border:1px solid #e6e8f0; border-radius: 14px;
      padding: 16px; margin: 12px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
    }

    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { display:block; font-weight:600; font-size:.9rem; margin-bottom: 6px; }
    input, select, textarea {
      width:100%; padding: 9px 10px; border-radius: 10px;
      border: 1px solid #cfd3e2; background:#fff; font-size:.95rem;
    }
    textarea { min-height: 90px; resize: vertical; }

    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius: 999px;
      border: 1px solid #e6e8f0; background:#fafbff; color:#334;
      font-size:.85rem;
    }

    .btns { display:flex; flex-wrap: wrap; gap:8px; margin-top: 10px; }
    button {
      border:none; border-radius: 999px; padding: 9px 14px; cursor:pointer;
      background:#0b57d0; color:#fff; font-size:.95rem;
    }
    button:hover:not(:disabled) { opacity:.92; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    button.secondary { background:#6b7280; }
    button.danger { background:#b42318; }
    button.good { background:#137333; }

    .box {
      border: 1px solid #e6e8f0; border-radius: 12px; padding: 12px;
      background: #fcfdff;
      white-space: pre-wrap;
      min-height: 64px;
    }

    .twoCol { display:grid; gap:12px; grid-template-columns: 1.1fr .9fr; }
    @media (max-width: 900px) { .twoCol { grid-template-columns: 1fr; } }

    .hint { color:#555; font-size:.88rem; margin-top: 6px; }
    .status { color:#444; font-size:.9rem; margin-top: 8px; }
    audio { width:100%; margin-top: 10px; display:none; }
    .small { font-size:.85rem; color:#555; }
    .divider { height:1px; background:#eef0f7; margin: 12px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Speaking App 2.5</h1>
      <div class="sub">Units 1‚Äì6 &amp; 8 ‚Ä¢ Speaking Task Type A / B / C ‚Ä¢ Record ‚Ä¢ Submit ‚Ä¢ Feedback</div>
    </header>

    <!-- Student Info -->
    <section class="card">
      <div class="grid">
        <div>
          <label for="studentName">Student name (optional)</label>
          <input id="studentName" type="text" placeholder="e.g., Ahmed Ali" />
          <div class="hint">Optional. Use if you want your teacher to identify you easily.</div>
        </div>

        <div>
          <label for="studentNumber">Student number (optional)</label>
          <input id="studentNumber" type="text" inputmode="numeric" placeholder="e.g., 2414062" />
          <div class="hint">Optional. Often better than a name for privacy.</div>
        </div>

        <div>
          <label for="classCode">Class / Group</label>
          <input id="classCode" type="text" value="E423" />
          <div class="hint">This helps your teacher organise submissions.</div>
        </div>
      </div>
    </section>

    <!-- Controls + Prompt + Suggestions -->
    <section class="card">
      <div class="twoCol">
        <div>
          <div class="grid">
            <div>
              <label for="unitSelect">Unit prompt</label>
              <select id="unitSelect">
                <option value="1">Unit 1 ‚Äì Animals</option>
                <option value="2">Unit 2 ‚Äì The Environment</option>
                <option value="3" selected>Unit 3 ‚Äì Transport</option>
                <option value="4">Unit 4 ‚Äì Customs &amp; Traditions</option>
                <option value="5">Unit 5 ‚Äì Health &amp; Fitness</option>
                <option value="6">Unit 6 ‚Äì Discovery &amp; Invention</option>
                <option value="8">Unit 8 ‚Äì Economics</option>
              </select>
            </div>

            <div>
              <label for="taskTypeSelect">Speaking Task Type</label>
              <select id="taskTypeSelect">
                <option value="A">Prompt A ‚Äì Short, personal response</option>
                <option value="B">Prompt B ‚Äì Structured response</option>
                <option value="C">Prompt C ‚Äì Opinion &amp; discussion</option>
              </select>
              <div class="hint" id="taskTypeHint"></div>
            </div>
          </div>

          <div class="btns">
            <button id="getPromptBtn">üéØ Get prompt</button>
            <button id="showSuggestionsBtn" class="secondary" type="button">üìå Show language help</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <span class="pill" id="pillUnit">Unit 3 ‚Äì Transport</span>
            <span class="pill" id="pillTask">Prompt A</span>
            <span class="pill" id="pillTarget">Target time: 30‚Äì45s</span>
          </div>

          <div style="margin-top:10px;">
            <label>Prompt</label>
            <div class="box" id="promptBox">Click <b>Get prompt</b> to load a speaking task.</div>
          </div>

          <div style="margin-top:10px;">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" placeholder="Optional: What was easy/difficult? Any words you want your teacher to check?"></textarea>
          </div>
        </div>

        <!-- Unit language help -->
        <aside>
          <div class="pill" style="justify-content:space-between; width:100%;">
            <span><b>Unit language help</b></span>
            <span class="small" id="langHelpLabel">Hidden</span>
          </div>

          <div id="langHelpPanel" style="display:none; margin-top:10px;">
            <div class="box" id="langHelpBox"></div>
            <div class="hint">Tip: You don‚Äôt need to use everything. Choose 2‚Äì3 items naturally.</div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Recorder -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="pill"><b>Recorder</b></div>
          <div class="hint">Allow microphone access when prompted.</div>
        </div>

        <div class="row">
          <div class="pill"><span>‚è± Timer:</span> <b id="timer">00:00</b></div>
          <div class="pill"><span>Status:</span> <b id="recStatus">Idle</b></div>
        </div>
      </div>

      <div class="btns">
        <button id="startBtn">‚è∫ Start recording</button>
        <button id="stopBtn" disabled>‚èπ Stop</button>
        <button id="playBtn" class="secondary" disabled>‚ñ∂ Play</button>
        <button id="clearBtn" class="danger" disabled>üóë Clear</button>
      </div>

      <audio id="audio" controls></audio>

      <div class="status" id="recHelp">
        Click <b>Start recording</b>, answer the prompt, then click <b>Stop</b>.
      </div>
    </section>

    <!-- Feedback -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="pill"><b>Feedback</b></div>
        <div class="pill"><span>Recording length:</span> <b id="durationLabel">‚Äî</b></div>
      </div>

      <div class="btns">
        <button id="feedbackBtn" class="good" disabled>üß† Get feedback</button>
      </div>

      <div class="hint">
        Feedback here is ‚Äúlight guidance‚Äù to help you improve. It is not a grade.
      </div>

      <div style="margin-top:10px;">
        <div class="box" id="feedbackBox">Record something first, then click <b>Get feedback</b>.</div>
      </div>
    </section>

    <!-- Submit -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="pill"><b>Submit to teacher</b></div>
        <div class="pill"><span>Connected:</span> <b id="connLabel">Not set</b></div>
      </div>

      <div class="hint">
        This sends your audio + details to your teacher‚Äôs Google Sheet/Drive via a Web App URL.
      </div>

      <div class="btns">
        <button id="sendBtn">üì® Send</button>
      </div>

      <div class="status" id="sendStatus"></div>
      <div class="hint small">
        If sending fails, your microphone recording stays on this page (until you refresh).
      </div>
    </section>

  </div>

<script>
  // =========================================================
  // CONFIG
  // =========================================================
  // Paste your Google Apps Script Web App URL here (the deployed "web app" URL):
  const SCRIPT_URL = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE";

  // If you want to force at least one identifier, set to true.
  const REQUIRE_NAME_OR_NUMBER = false;

  // =========================================================
  // TASK TYPE META
  // =========================================================
  const taskTypeMeta = {
    A: { label: "Prompt A", target: "30‚Äì45s", hint: "Short personal answers: habits, preferences, experiences." },
    B: { label: "Prompt B", target: "1‚Äì2 min", hint: "Longer answer with structure: give reasons and an example." },
    C: { label: "Prompt C", target: "1‚Äì2 min", hint: "Opinion/discussion: compare ideas, explain, and justify your view." },
  };

  // =========================================================
  // PROMPTS (Units 1‚Äì6 & 8 ‚Ä¢ A/B/C)
  // =========================================================
  const prompts = {
    1: { // Animals
      A: [
        "Do you like animals? Why or why not?",
        "Did you have any pets when you were a child?",
        "Are there any animals that are important symbols in your country?",
        "What is an animal you are afraid of? Why?"
      ],
      B: [
        "Describe an animal you find interesting. Say what it is, where it lives, what it looks like, and why it interests you.",
        "Describe a time you saw animals in a special place (zoo, farm, desert, sea, etc.). Say where you went, what you saw, and how you felt."
      ],
      C: [
        "Do you think zoos are good or bad for animals? Why?",
        "Should people keep exotic animals as pets? Explain your opinion.",
        "How can people protect endangered animals effectively?"
      ]
    },

    2: { // Environment
      A: [
        "Is there a park or green area near where you live?",
        "How often do you spend time outdoors?",
        "What environmental problems do you notice in your city?",
        "Do you recycle at home? Why/why not?"
      ],
      B: [
        "Describe a natural place you have visited that you really liked. Say where it is, what it is like, and why it was memorable.",
        "Describe a time you tried to do something good for the environment. Say what you did, why, and what happened."
      ],
      C: [
        "Who should do more to protect the environment: individuals or governments? Why?",
        "Is public transport an effective solution for pollution? Explain.",
        "Do you think young people are more environmentally aware than older people? Why/why not?"
      ]
    },

    3: { // Transport
      A: [
        "How do you usually travel to college or work?",
        "What is your favourite type of transport? Why?",
        "Is traffic a big problem in your city?",
        "Would you like to learn to drive (or drive more)? Why/why not?"
      ],
      B: [
        "Describe a journey you remember well. Say where you went, how you travelled, who you went with, and why you remember it.",
        "Describe a form of transport you would like to try. Say what it is, where you would use it, and why it interests you."
      ],
      C: [
        "Should cities reduce car use? Why or why not?",
        "What are the advantages and disadvantages of public transport?",
        "How might technology make transport safer in the future?"
      ]
    },

    4: { // Customs & Traditions
      A: [
        "What is your favourite holiday or festival?",
        "Do you enjoy traditional food from your country?",
        "Do young people in your country follow traditional customs?",
        "Is it important to keep traditions? Why/why not?"
      ],
      B: [
        "Describe an important tradition in your country. Say what it is, when people follow it, and why it matters.",
        "Describe a celebration you attended that you enjoyed. Say what it was, who was there, and what happened."
      ],
      C: [
        "Do you think traditions are becoming weaker? Why/why not?",
        "How can countries protect cultural traditions while modernising?",
        "Does globalisation make cultures more similar? Explain."
      ]
    },

    5: { // Health & Fitness
      A: [
        "How often do you exercise, and what kind of exercise do you do?",
        "What do you do to stay healthy?",
        "How important is sleep for your daily performance?",
        "Do you prefer exercising alone or with others? Why?"
      ],
      B: [
        "Describe a time when you tried to improve your health or fitness. Say what you did, why, and what changed.",
        "Describe a sport or activity popular with young adults. Say what it is, where people do it, and why it is popular."
      ],
      C: [
        "Are modern lifestyles becoming more unhealthy? Why/why not?",
        "What can schools/colleges do to encourage healthy habits?",
        "Should governments invest more in public sports facilities? Why/why not?"
      ]
    },

    6: { // Discovery & Invention
      A: [
        "What invention do you use most in daily life?",
        "Do you like hearing about scientific discoveries? Why/why not?",
        "Which technology is hardest to live without? Why?",
        "Have you ever had an idea for an invention? What was it?"
      ],
      B: [
        "Describe an invention that changed people‚Äôs lives. Say what it is, how it‚Äôs used, and why it matters.",
        "Describe a scientist/inventor you admire. Say who they are, what they created/discovered, and why you admire them."
      ],
      C: [
        "Does technology always improve life? Why/why not?",
        "What are advantages and disadvantages of technology in education?",
        "Will AI create more jobs or reduce jobs in the future? Explain."
      ]
    },

    8: { // Economics
      A: [
        "Do you prefer saving money or spending money? Why?",
        "What things are becoming more expensive where you live?",
        "Is it easy for young people to find part-time work in your country? Why/why not?",
        "How do students usually manage their money each month?"
      ],
      B: [
        "Describe a job you would like to have in the future. Say what the job is, why you want it, and how it could help you in life.",
        "Describe a time when you saved money for something important. Say what it was, how you saved, and how you felt."
      ],
      C: [
        "Is money more important than job satisfaction? Why or why not?",
        "Should governments do more to support unemployed young people? Why/why not?",
        "Do you think prices and living costs are a major problem for young adults today? Explain."
      ]
    }
  };

  // =========================================================
  // UNIT LANGUAGE HELP (Grammar + Vocab suggestions)
  // =========================================================
  const unitLanguageHelp = {
    1: {
      grammar: [
        "Comparatives: bigger than / more dangerous than",
        "Linking: because / but / however",
        "Modals: should / shouldn‚Äôt (for advice about animals)"
      ],
      vocab: [
        "habitat, endangered, predator, prey, species",
        "domestic, wild, shelter, feed, protect"
      ],
      useful: [
        "In my opinion, ‚Ä¶",
        "I think ‚Ä¶ because ‚Ä¶",
        "However, ‚Ä¶"
      ]
    },
    2: {
      grammar: [
        "Cause & effect: because / because of / so / as a result",
        "Giving examples: for example / such as",
        "Advantages & disadvantages: one benefit is‚Ä¶ / one drawback is‚Ä¶"
      ],
      vocab: [
        "pollution, recycling, waste, climate, resources",
        "renewable energy, carbon footprint, conservation"
      ],
      useful: [
        "This leads to ‚Ä¶",
        "As a result, ‚Ä¶",
        "For example, ‚Ä¶"
      ]
    },
    3: {
      grammar: [
        "Suggestions: we could / why don‚Äôt we / it might be better to‚Ä¶",
        "First conditional: If‚Ä¶, will‚Ä¶",
        "Comparatives & superlatives: faster / the safest"
      ],
      vocab: [
        "commute, traffic jam, route, fare, platform",
        "efficient, convenient, reliable, crowded"
      ],
      useful: [
        "I usually ‚Ä¶",
        "One advantage is ‚Ä¶",
        "If there‚Äôs traffic, ‚Ä¶"
      ]
    },
    4: {
      grammar: [
        "Adverbs of frequency: usually / sometimes / rarely",
        "Cause & effect: because / so",
        "Contrasting: although / however"
      ],
      vocab: [
        "custom, tradition, ceremony, hospitality",
        "celebrate, respect, values, community"
      ],
      useful: [
        "People usually ‚Ä¶",
        "Although ‚Ä¶, ‚Ä¶",
        "It‚Äôs important because ‚Ä¶"
      ]
    },
    5: {
      grammar: [
        "Modals for advice/obligation: should / have to / mustn‚Äôt",
        "Linking: however / on the other hand",
        "Giving reasons: because / this is why‚Ä¶"
      ],
      vocab: [
        "diet, balanced, nutrients, routine, stamina",
        "workout, strength, cardio, recovery, sleep"
      ],
      useful: [
        "To stay healthy, I‚Ä¶",
        "I try to‚Ä¶ because‚Ä¶",
        "On the other hand, ‚Ä¶"
      ]
    },
    6: {
      grammar: [
        "Passive (for inventions): was invented / is used",
        "Purpose: to / in order to",
        "Opinion + support: I believe‚Ä¶ because‚Ä¶"
      ],
      vocab: [
        "innovation, device, breakthrough, research, experiment",
        "invent, discover, develop, improve, impact"
      ],
      useful: [
        "It was invented to‚Ä¶",
        "Nowadays, it is used for‚Ä¶",
        "It has changed‚Ä¶ by‚Ä¶"
      ]
    },
    8: {
      grammar: [
        "Comparatives: more expensive than / less affordable than",
        "Cause & effect: because / due to / as a result",
        "Modals for advice/obligation: should / have to (money habits)",
        "First conditional: If prices increase, people will‚Ä¶"
      ],
      vocab: [
        "income, salary, wage, budget, expenses",
        "afford, save, spend, cost, value",
        "employment, unemployment, workplace, career",
        "prices, living costs, inflation"
      ],
      useful: [
        "In my opinion, ‚Ä¶",
        "One reason is that ‚Ä¶",
        "As a result, ‚Ä¶",
        "On the other hand, ‚Ä¶"
      ]
    }
  };

  // =========================================================
  // UI ELEMENTS
  // =========================================================
  const unitSelect = document.getElementById("unitSelect");
  const taskTypeSelect = document.getElementById("taskTypeSelect");

  const pillUnit = document.getElementById("pillUnit");
  const pillTask = document.getElementById("pillTask");
  const pillTarget = document.getElementById("pillTarget");
  const taskTypeHint = document.getElementById("taskTypeHint");

  const promptBox = document.getElementById("promptBox");

  const showSuggestionsBtn = document.getElementById("showSuggestionsBtn");
  const langHelpPanel = document.getElementById("langHelpPanel");
  const langHelpBox = document.getElementById("langHelpBox");
  const langHelpLabel = document.getElementById("langHelpLabel");

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const playBtn = document.getElementById("playBtn");
  const clearBtn = document.getElementById("clearBtn");
  const audio = document.getElementById("audio");
  const recStatus = document.getElementById("recStatus");
  const recHelp = document.getElementById("recHelp");

  const timerEl = document.getElementById("timer");
  const durationLabel = document.getElementById("durationLabel");

  const feedbackBtn = document.getElementById("feedbackBtn");
  const feedbackBox = document.getElementById("feedbackBox");

  const sendBtn = document.getElementById("sendBtn");
  const sendStatus = document.getElementById("sendStatus");
  const connLabel = document.getElementById("connLabel");

  // Set connection label
  connLabel.textContent = (SCRIPT_URL && SCRIPT_URL !== "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") ? "Yes" : "Not set";

  // =========================================================
  // PROMPT LOGIC
  // =========================================================
  function unitLabel() {
    return unitSelect.options[unitSelect.selectedIndex].textContent;
  }

  function updatePills() {
    const u = unitSelect.value;
    const t = taskTypeSelect.value;
    pillUnit.textContent = unitLabel();
    pillTask.textContent = taskTypeMeta[t].label;
    pillTarget.textContent = "Target time: " + taskTypeMeta[t].target;
    taskTypeHint.textContent = taskTypeMeta[t].hint;
  }

  function renderLanguageHelp() {
    const u = unitSelect.value;
    const data = unitLanguageHelp[u];

    if (!data) {
      langHelpBox.textContent = "No language help available for this unit yet.";
      return;
    }

    const grammar = data.grammar.map(x => `‚Ä¢ ${x}`).join("\n");
    const vocab = data.vocab.map(x => `‚Ä¢ ${x}`).join("\n");
    const useful = data.useful.map(x => `‚Ä¢ ${x}`).join("\n");

    langHelpBox.textContent =
`Grammar suggestions:
${grammar}

Vocabulary suggestions:
${vocab}

Helpful phrases:
${useful}`;
  }

  document.getElementById("getPromptBtn").addEventListener("click", () => {
    const u = unitSelect.value;
    const t = taskTypeSelect.value;

    const list = (prompts[u] && prompts[u][t]) ? prompts[u][t] : [];
    if (!list.length) {
      promptBox.textContent = "No prompt available for this unit/task type yet.";
      return;
    }
    const pick = list[Math.floor(Math.random() * list.length)];
    promptBox.textContent = pick;
  });

  unitSelect.addEventListener("change", () => {
    updatePills();
    renderLanguageHelp();
  });

  taskTypeSelect.addEventListener("change", () => {
    updatePills();
  });

  showSuggestionsBtn.addEventListener("click", () => {
    const isOpen = langHelpPanel.style.display !== "none";
    langHelpPanel.style.display = isOpen ? "none" : "block";
    langHelpLabel.textContent = isOpen ? "Hidden" : "Visible";
    showSuggestionsBtn.textContent = isOpen ? "üìå Show language help" : "üìå Hide language help";
  });

  // Init UI
  updatePills();
  renderLanguageHelp();

  // =========================================================
  // RECORDER + TIMER
  // =========================================================
  let mediaRecorder = null;
  let chunks = [];
  let audioBlob = null;
  let stream = null;

  let timerInterval = null;
  let startTime = 0;
  let recordedSeconds = 0;

  function fmtTime(totalSeconds) {
    const m = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
    const s = String(totalSeconds % 60).padStart(2, "0");
    return `${m}:${s}`;
  }

  function startTimer() {
    startTime = Date.now();
    timerEl.textContent = "00:00";
    recordedSeconds = 0;
    timerInterval = setInterval(() => {
      recordedSeconds = Math.floor((Date.now() - startTime) / 1000);
      timerEl.textContent = fmtTime(recordedSeconds);
    }, 250);
  }

  function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    durationLabel.textContent = recordedSeconds ? fmtTime(recordedSeconds) : "‚Äî";
  }

  async function startRecording() {
    if (!navigator.mediaDevices?.getUserMedia) {
      alert("Recording is not supported in this browser.");
      return;
    }

    try {
      if (stream) stream.getTracks().forEach(t => t.stop());

      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];

      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };

      mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());

        audioBlob = new Blob(chunks, { type: "audio/webm" });
        const url = URL.createObjectURL(audioBlob);
        audio.src = url;
        audio.style.display = "block";

        playBtn.disabled = false;
        clearBtn.disabled = false;
        feedbackBtn.disabled = false;

        recStatus.textContent = "Stopped";
        recHelp.innerHTML = "Recording saved. You can <b>Play</b>, get <b>Feedback</b>, or <b>Send</b>.";
      };

      mediaRecorder.start();

      startBtn.disabled = true;
      stopBtn.disabled = false;
      playBtn.disabled = true;
      clearBtn.disabled = true;
      feedbackBtn.disabled = true;

      recStatus.textContent = "Recording";
      recHelp.textContent = "Recording‚Ä¶ speak now.";
      startTimer();

    } catch (err) {
      console.error(err);
      alert("Could not start recording. Check microphone permissions.");
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      stopBtn.disabled = true;
      startBtn.disabled = false;
      stopTimer();
    }
  }

  function clearRecording() {
    audioBlob = null;
    chunks = [];
    audio.removeAttribute("src");
    audio.style.display = "none";
    playBtn.disabled = true;
    clearBtn.disabled = true;
    feedbackBtn.disabled = true;
    durationLabel.textContent = "‚Äî";
    timerEl.textContent = "00:00";
    recStatus.textContent = "Idle";
    recHelp.innerHTML = "No recording yet. Click <b>Start recording</b>.";
    feedbackBox.textContent = "Record something first, then click Get feedback.";
  }

  startBtn.addEventListener("click", startRecording);
  stopBtn.addEventListener("click", stopRecording);
  playBtn.addEventListener("click", () => { if (audio.src) audio.play(); });
  clearBtn.addEventListener("click", clearRecording);

  // =========================================================
  // STUDENT-FACING "GET FEEDBACK" (light guidance)
  // =========================================================
  function getFeedbackText() {
    const u = unitSelect.value;
    const t = taskTypeSelect.value;
    const meta = taskTypeMeta[t];
    const help = unitLanguageHelp[u];

    const time = recordedSeconds || 0;

    let timeComment = "";
    if (t === "A") {
      if (time < 20) timeComment = "Your answer was quite short. Try adding 1 reason + 1 example.";
      else if (time > 70) timeComment = "You spoke for a long time for Task A. Try a shorter, clearer answer.";
      else timeComment = "Your length is suitable for Task A.";
    } else {
      if (time < 45) timeComment = "Your answer was a little short. Try: point ‚Üí reason ‚Üí example ‚Üí short conclusion.";
      else if (time > 180) timeComment = "You spoke for a long time. Try to stay focused and avoid repetition.";
      else timeComment = "Your length is suitable for this task type.";
    }

    const grammarPicks = (help?.grammar || []).slice(0, 2).map(x => `‚Ä¢ ${x}`).join("\n");
    const vocabPicks = (help?.vocab || []).slice(0, 4).map(x => `‚Ä¢ ${x}`).join("\n");
    const phrasePicks = (help?.useful || []).slice(0, 2).map(x => `‚Ä¢ ${x}`).join("\n");

    const taskGuide = (t === "A")
      ? "Aim: answer clearly + add one supporting detail."
      : (t === "B")
        ? "Aim: structure your talk: introduction ‚Üí 2‚Äì3 points ‚Üí example ‚Üí ending."
        : "Aim: give an opinion, compare ideas, and justify your view with reasons.";

    return (
`Task type: ${meta.label}
Target time: ${meta.target}
${taskGuide}

Timing check:
${timeComment}

Try using (from this unit):
Grammar:
${grammarPicks || "‚Ä¢ (no items set)"}

Vocabulary:
${vocabPicks || "‚Ä¢ (no items set)"}

Helpful phrases:
${phrasePicks || "‚Ä¢ (no items set)"}

Self-check (quick):
‚Ä¢ Did I answer the question directly?
‚Ä¢ Did I give at least ONE reason?
‚Ä¢ Did I give ONE example or detail?
‚Ä¢ Did I use 2‚Äì3 unit words naturally?`
    );
  }

  feedbackBtn.addEventListener("click", () => {
    if (!audioBlob) return;
    feedbackBox.textContent = getFeedbackText();
  });

  // =========================================================
  // SEND LOGIC (audio + metadata)
  // =========================================================
  sendBtn.addEventListener("click", async () => {
    const name = document.getElementById("studentName").value.trim();
    const number = document.getElementById("studentNumber").value.trim();
    const classCode = document.getElementById("classCode").value.trim();
    const notes = document.getElementById("notes").value.trim();
    const unit = unitSelect.value;
    const taskType = taskTypeSelect.value;
    const promptText = promptBox.textContent.trim();

    if (REQUIRE_NAME_OR_NUMBER && (!name && !number)) {
      alert("Please enter either your name or your student number.");
      return;
    }
    if (!classCode) {
      alert("Please enter your class/group.");
      return;
    }
    if (!promptText || promptText.includes("Get prompt")) {
      alert("Please click 'Get prompt' first.");
      return;
    }
    if (!audioBlob) {
      alert("Please record your answer before sending.");
      return;
    }
    if (!SCRIPT_URL || SCRIPT_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
      alert("The Google Apps Script Web App URL is not set in the code yet.");
      return;
    }

    sendBtn.disabled = true;
    sendStatus.textContent = "Sending‚Ä¶";

    try {
      const fd = new FormData();
      fd.append("studentName", name);
      fd.append("studentNumber", number);
      fd.append("classCode", classCode);
      fd.append("unit", unit);
      fd.append("taskType", taskType);
      fd.append("prompt", promptText);
      fd.append("notes", notes);
      fd.append("durationSeconds", String(recordedSeconds || 0));
      fd.append("audio", audioBlob, `speaking_${classCode}_U${unit}_${taskType}_${Date.now()}.webm`);

      const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
      if (!res.ok) throw new Error("Network response not OK");

      sendStatus.textContent = "‚úÖ Sent successfully.";
    } catch (e) {
      console.error(e);
      sendStatus.textContent = "‚ùå Failed to send. Please try again (or check the Web App URL).";
    } finally {
      sendBtn.disabled = false;
    }
  });
</script>
</body>
</html>
